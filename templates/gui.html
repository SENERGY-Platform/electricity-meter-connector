<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<title>Ferraris Arduino Serial Gateway</title>
	<meta name="keywords" content="" />
	<meta name="description" content="" />
	<link rel=stylesheet type=text/css href="{{ url_for('static', filename='style.css') }}">
	<script>
		function httpPost(uri) {
		    var xhttp = new XMLHttpRequest();
			xhttp.open("POST", uri, true);
			xhttp.send();
		}
	</script>
	<script>
		function httpPostConf(uri, nat, dt, lld) {
		    var xhttp = new XMLHttpRequest();
			xhttp.open("POST", uri, true);
			xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
			xhttp.send("nat=" + nat + "&dt=" + dt + "&lld=" + lld);
		}
	</script>
</head>

<body>
<div class="wrapper">

	<header class="header">
		<div class="main-navigation">
			{% for device in devices %}
			{% if device == d_id %}
			<button class="btnactive" type="button" onclick="location.href=('{{ device }}');">Device {{ device }}</button>
			{% else %}
			<button class="btn" type="button" onclick="location.href=('{{ device }}');">Device {{ device }}</button>
			{% endif %}
			{% endfor %}
		</div>
    </header><!-- .header-->

	<div class="middle">

		<div class="container">
			<main id="content" class="content">

			</main><!-- .content -->
		</div><!-- .container-->

		<aside class="left-sidebar">
			<div class="sub-navigation">
				{% if d_id %}
				<button class="btn" type="button" id="myBtn">Configure</button>
				<button class="btn" type="button" onclick="httpPost('{{ d_id }}/mr')">Manual Read</button>
				<button class="btn" type="button" onclick="httpPost('{{ d_id }}/strt')">Start Detection</button>
				<button class="btn" type="button" onclick="httpPost('{{ d_id }}/stp')">Stop Current Action</button>
				<button class="btn" type="button" onclick="httpPost('{{ d_id }}/eas')">Enable Auto Start</button>
				<button class="btn" type="button" onclick="httpPost('{{ d_id }}/das')">Disable Auto Start</button>
				<button class="btn" type="button" onclick="httpPost('{{ d_id }}/res')">Reset</button>
				{% endif %}
			</div>
		</aside><!-- .left-sidebar -->

	</div><!-- .middle-->

</div><!-- .wrapper -->

<footer class="footer">
	<img id="logo" src="{{ url_for('static', filename='logo.svg') }}">
</footer><!-- .footer -->

<div id="myModal" class="modal">

  <!-- Modal content -->
	<div class="modal-content">
		<span class="close">OK</span>
		<label for="nat">New Average Threshold: </label><input id="nat" type="number" min="0" max="9000" required>
		<label for="dt">Detection Threshold: </label><input id="dt" type="number" min="0" max="9000" required>
		<label for="lld">Lower Limit Distance: </label><input id="lld" type="number" min="0" max="9000" required>
		<label for="wsec">Rotations / kWh: </label><input id="wsec" type="number" min="0" max="100000" required>
	</div>

</div>

<script>
    var modal = document.getElementById('myModal');
    var btn = document.getElementById("myBtn");
    var span = document.getElementsByClassName("close")[0];
    btn.onclick = function() {
        modal.style.display = "block";
    }
    span.onclick = function() {
        var nat = document.getElementById("nat");
        var dt = document.getElementById("dt");
        var lld = document.getElementById("lld");
        var wsec = document.getElementById("wsec");
        if (nat.checkValidity()) {
            if (dt.checkValidity()) {
                if (lld.checkValidity()) {
                    if (wsec.checkValidity()) {
                        httpPostConf('{{ d_id }}/conf', nat.value, dt.value, lld.value, wsec.value)
						modal.style.display = "none";
						nat.value = '';
						dt.value = '';
						lld.value = '';
						wsec.value = '';
					} else {
                        wsec.value = '';
					}
                } else {
                    lld.value = '';
				}
            } else {
                dt.value = '';
			}
        } else {
            nat.value = '';
		}
    }
    window.onclick = function(event) {
        if (event.target == modal) {
            modal.style.display = "none";
            nat.value = '';
			dt.value = '';
			lld.value = '';
			wsec.value = '';
        }
    }
</script>

{% if d_id %}
<script>
    var ws = new WebSocket("ws://127.0.0.1:5678/");
    ws.onmessage = function (event) {
        var content = document.createTextNode(event.data);
        document.getElementById('content').innerHTML += event.data + '<br>';
        document.getElementById('content').scrollTop = document.getElementById('content').scrollHeight
    };
</script>
{% endif %}

</body>
</html>